---
title: 小米路由Hosts
article: false
tags: 
  - 修仙秘籍
  - 小米路由
  - Hosts
  - 网络
categories: 
editor: markdown
permalink: /docs/cultivation_secrets/mi_hosts/
date: 2023-09-27 12:16:17
---

# 📶 小米路由Hosts

**小米路由Hosts** 是一个专门用于将本地Hosts文件同步到小米路由器的插件，通过小米路由器官方API实现Hosts配置的自动同步，为全网设备提供域名解析优化。

## ⚙️ 功能特点

### 🔄 自动同步
- **官方API**：基于小米路由器官方API接口进行同步
- **定时同步**：支持Cron表达式定时自动同步
- **智能模式**：支持替换模式和合并模式
- **选择性同步**：可选择同步全部Hosts或仅自定义Hosts部分

### 🌐 网络优化
- **全网覆盖**：影响连接到路由器的所有设备
- **DNS加速**：通过Hosts优化DNS解析速度
- **广告拦截**：在路由器层面拦截广告域名
- **CDN优选**：配合Cloudflare IP优选使用

## 🚀 配置指南

### 基础配置

插件的核心配置包含以下参数：

### 📋 必填参数

1. **应用ID (appId)**：
   - 小米路由器API的应用标识
   - 从小米路由器管理界面获取

2. **设备ID (deviceId)**：
   - 路由器的唯一设备标识
   - 通常从路由器API响应中获取

3. **客户端ID (clientId)**：
   - API客户端标识
   - 用于身份验证

4. **访问令牌 (token)**：
   - API访问凭证
   - 从小米路由器授权获取

### ⚙️ 可选参数

1. **作用域 (scope)**：
   - API访问权限范围
   - 默认值：`1+1000+3`

2. **同步周期 (cron)**：
   - 定时同步的Cron表达式
   - 默认：`0 6 * * *`（每天早上6点）

3. **读取全部hosts**：
   - 开启：读取系统hosts文件的全部内容
   - 关闭：仅读取通过「自定义hosts」插件添加的部分（推荐）

4. **合并模式**：
   - 开启：与远程hosts合并（可能导致hosts越来越大）
   - 关闭：使用替换模式，覆盖远程原有hosts（推荐）

5. **忽略列表**：
   - 需要忽略的IP地址或域名
   - 使用 `|` 分隔，例如：`10.10.10.1|wiki.movie-pilot.org`

## 📖 使用说明

### 参数获取方法

**重要**：以下步骤仅供参考，具体界面可能因路由器固件版本而异

1. **准备工作**：
   - 打开抓包工具（如Charles、Fiddler等）先不抓包
   - 确保手机和电脑在同一网络

2. **获取设备ID**：
   - 打开米家APP，进入路由器主界面
   - 启动抓包工具开始抓包
   - 在路由器界面随便操作两下
   - 找到类似 `http://路由器网关/cgi-bin/luci/api/xqsystem/init_info` 的请求
   - 从响应中找到 `routerId` 即为 `deviceID`

3. **获取API参数**：
   - 在浏览器中访问：`http://s.miwifi.com/dist/userhosts/index.html?deviceID=设备ID`
   - 登录小米账号后进入自定义hosts界面
   - 按F12打开开发者工具，切换到Network标签
   - 刷新页面或操作界面
   - 找到 `https://www.gorouter.info/api-third-party/service/internal/custom_host_get` 请求
   - 从请求参数中获取：`appId`、`deviceId`、`clientId`、`scope`、`token`

### 同步流程

1. **数据读取**：
   - 根据配置读取本地hosts（全部或自定义部分）
   - 获取远程路由器当前hosts配置

2. **数据处理**：
   - 应用忽略列表过滤
   - 验证IP地址和域名格式
   - 根据合并模式处理数据

3. **同步执行**：
   - 通过API推送hosts到路由器
   - 验证同步结果
   - 发送通知（如已开启）

### 同步模式详解

#### 替换模式（推荐）
- **工作方式**：完全替换路由器上的hosts
- **适用场景**：希望路由器hosts与本地完全一致
- **优点**：hosts文件保持简洁，不会无限增长
- **注意**：会覆盖路由器上的原有hosts

#### 合并模式
- **工作方式**：与路由器现有hosts合并
- **适用场景**：需要保留路由器原有hosts设置
- **缺点**：hosts文件可能越来越大，需要定期清理
- **注意**：相同域名以本地hosts为准

## ⚙️ 定时任务配置

### Cron表达式示例

```bash
# 每天早上6点同步
0 6 * * *

# 每6小时同步一次
0 */6 * * *

# 每周日凌晨4点同步
0 4 * * 0

# 每月1日凌晨2点同步
0 2 1 * *
```

> 📖 **详细说明**：关于Cron表达式的完整语法和更多示例，请参考：[Cron表达式说明文档](/docs/other/cron_rule)

## ⚠️ 注意事项

### 使用前提

1. **路由器要求**：
   - 小米路由器系列产品
   - 支持官方API接口的固件版本
   - 已开启自定义hosts功能

2. **网络要求**：
   - Media Saber能访问互联网
   - 稳定的网络连接
   - 能访问小米路由器API服务

### 重要提醒

1. **API限制**：
   - 小米路由器API可能有调用频率限制
   - 建议设置合理的同步间隔

2. **Token有效期**：
   - 访问令牌可能会过期
   - 如果同步失败，请重新获取token

3. **网络安全**：
   - 妥善保管API参数，避免泄露
   - 建议定期更换访问令牌

### 故障排除

1. **同步失败**：
   - 检查API参数是否正确
   - 验证token是否过期
   - 确认网络连接正常

2. **获取参数困难**：
   - 尝试不同的浏览器
   - 清除浏览器缓存后重试
   - 确保米家APP版本较新

3. **DNS不生效**：
   - 等待DNS缓存刷新（通常需要几分钟）
   - 手动清除设备DNS缓存
   - 重启路由器（如有必要）

## � 配套使用

### 推荐组合

1. **自定义Hosts + 小米路由Hosts**：
   - 在本地管理hosts规则
   - 自动同步到路由器生效全网

2. **Cloudflare IP优选 + 小米路由Hosts**：
   - 优选最快的Cloudflare IP
   - 通过路由器hosts全网生效

3. **广告拦截hosts + 小米路由Hosts**：
   - 导入广告拦截域名列表
   - 在路由器层面拦截广告请求

## 🔗 相关链接

- [修仙秘籍主页](/docs/cultivation_secrets/main/)
- [Cron表达式说明](/docs/other/cron_rule)
- [自定义Hosts](/docs/cultivation_secrets/custom_hosts/)
- [Cloudflare IP优选](/docs/cultivation_secrets/cloudflare_ip_optimization/)

---

🎯 **提示**：小米路由Hosts同步基于官方API，无需破解路由器，相对安全稳定。
